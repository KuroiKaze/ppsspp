name: ðŸŽ® PSP Homebrew Release

# 1. Trigger: LÃ¶st bei Tag-Push ODER manuellem Start aus.
on:
  push:
    tags:
      - 'v*' # Matcht Tags wie v1.0.0
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag Name for the Release (e.g., v1.0.3)'
        required: true
        default: 'dev-build' # Fallback-Wert

permissions:
  contents: write

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    # NEU: Definiert Variablen, die den Tag-Namen aus dem richtigen Trigger ziehen
    env:
      # Holt den reinen Tag-Namen: Entweder vom manuellen Input ODER vom Tag-Push
      RELEASE_TAG: ${{ github.event.inputs.tag_name || github.ref_name }}

    steps:
      # Step 1: Repository klonen
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # Step 2: Bereinigung und Kompilierung (Docker)
      - name: Build EBOOT.PBP using PSPDEV Docker
        run: |
          BUILD_DIR="build_pbp"
          
          # Bereinigung des lokalen Caches (um Fehler zu vermeiden)
          echo "Cleaning up local CMake cache..."
          rm -rf CMakeCache.txt CMakeFiles

          # FÃ¼hrt den Container aus und kompiliert das Projekt
          docker run -v $PWD:/source pspdev/pspdev:latest /bin/bash -c "
            export PSPDEV=/usr/local/pspdev
            cd /source
            
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR
            
            # CMake Konfiguration
            psp-cmake ..
            
            # Kompilieren
            make -j$(nproc)
          "

      # Step 3: Artefakt hochladen (Optional, nur zur ÃœberprÃ¼fung im Actions Tab)
      - name: Upload EBOOT.PBP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EBOOT-PBP-Build
          path: build_pbp/EBOOT.PBP

      # Step 4: GitHub Release erstellen
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # KORREKTUR: Verwendet die bereinigte Umgebungsvariable
          tag_name: ${{ env.RELEASE_TAG }} 
          release_name: Release ${{ env.RELEASE_TAG }} 
          draft: false
          prerelease: false

      # Step 5: EBOOT.PBP an das Release anhÃ¤ngen
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build_pbp/EBOOT.PBP
          # KORREKTUR: Benennung einfach als EBOOT.PBP
          asset_name: EBOOT.PBP
          asset_content_type: application/octet-stream
