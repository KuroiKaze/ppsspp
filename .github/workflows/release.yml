# Workflow-Name, sichtbar im GitHub Actions Tab
name: ðŸŽ® PSP EBOOT.PBP Release erstellen

# Der Workflow wird nur bei Pushes auf dem main-Branch ausgelÃ¶st.
on:
  push:
    branches:
      - main

jobs:
  # Job 1: Baut das PSP-Projekt und erstellt die EBOOT.PBP
  build_psp:
    # FÃ¼hrt den Job im PSP Toolchain Container aus
    runs-on: ubuntu-latest
    container: ghcr.io/pspdev/psptoolchain:latest
    
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4

      - name: Umgebungsvariablen setzen
        run: |
          # Stellt sicher, dass die Umgebungsvariablen fÃ¼r das PSPDEV-Toolchain korrekt gesetzt sind
          export PSPDEV=/usr/local/pspdev
          export PATH=$PATH:$PSPDEV/bin

      - name: Installiere CMake
        run: |
          # Der PSPDEV-Container basiert typischerweise auf Alpine Linux.
          # Wir installieren cmake, da es nicht standardmÃ¤ÃŸig enthalten ist.
          apk update
          apk add cmake

      - name: PSP-Projekt bauen (mit oder ohne custom Skript)
        run: |
          # --- Priorisiere eigenes Build-Skript ---
          if [ -f build-psp.sh ]; then
            echo "FÃ¼hre benutzerdefiniertes PSP-Build-Skript (./build-psp.sh) aus."
            chmod +x build-psp.sh
            ./build-psp.sh
            
            # WICHTIG: Das custom Skript MUSS die EBOOT.PBP in das Verzeichnis ./psp-build/ legen!
            
          # --- Fallback auf standard CMake-Build ---
          else
            echo "Kein benutzerdefiniertes Skript gefunden. FÃ¼hre Standard-CMake-Build aus."
            
            # Stellt sicher, dass das Build-Verzeichnis sauber ist, um Fehler zu vermeiden.
            rm -rf psp-build
            mkdir psp-build
            cd psp-build
            
            # Annahme: Toolchain-Datei liegt im PSPDEV-Pfad
            TOOLCHAIN_FILE="${PSPDEV}/share/pspsdk/cmake/Toolchain-psp.cmake"
            
            # Konfiguriere CMake unter Verwendung der PSP Toolchain
            cmake .. -DCMAKE_TOOLCHAIN_FILE=${TOOLCHAIN_FILE} -DPSP=1
            
            # Starte den Build-Prozess und nutze alle verfÃ¼gbaren Kerne
            make -j $(getconf _NPROCESSORS_ONLN)
            
            # Die erstellte EBOOT.PBP liegt nun im 'psp-build'-Verzeichnis
          fi
          
      - name: EBOOT.PBP als Artefakt hochladen
        uses: actions/upload-artifact@v4
        with:
          # Name des Artefakts, das im nÃ¤chsten Job heruntergeladen wird
          name: psp-release-artifact
          path: psp-build/EBOOT.PBP # Pfad wurde aktualisiert
          retention-days: 1 # TemporÃ¤re Speicherung

  # Job 2: Erstellt das Release und lÃ¤dt die EBOOT.PBP hoch
  create_release:
    # Stellt sicher, dass dieses Release nur nach erfolgreichem Build startet
    needs: build_psp
    runs-on: ubuntu-latest
    
    steps:
      - name: Build Artefakt herunterladen
        uses: actions/download-artifact@v4
        with:
          name: psp-release-artifact
          path: ./release_assets

      - name: Kurzen SHA fÃ¼r Tag und Release-Name ermitteln
        id: slug
        run: echo "sha8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: GitHub Release erstellen
        uses: softprops/action-gh-release@v1
        with:
          # Verwendet den kurzen Commit-SHA als eindeutiges Tag
          tag_name: v${{ steps.slug.outputs.sha8 }}
          name: PSP Build ${{ steps.slug.outputs.sha8 }}
          body: |
            Automatisch erstelltes Release von Commit ${{ github.sha }}.
            
          
          # HÃ¤ngt die EBOOT.PBP als Asset an das Release an
          files: ./release_assets/EBOOT.PBP
