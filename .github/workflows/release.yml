name: PSP Homebrew Build

# 1. Trigger: Startet den Workflow bei jedem Push auf dem 'main' Branch und bei Pull Requests
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# 2. Jobs: Die auszuführenden Aufgaben
jobs:
  build:
    # Der Runner, auf dem das Docker Image ausgeführt wird
    runs-on: ubuntu-latest

    # 3. Schritte: Die einzelnen Aktionen
    steps:
      # Step 1: Repository klonen
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Optional: Wenn Ihr Projekt Submodule verwendet (z.B. psp-libs)
          submodules: true

      # Step 2: Docker Image pullen (pspdev/pspdev:latest)
      - name: Pull PSPDEV Docker Image
        # Docker wird das Image bei Bedarf automatisch pullen, aber dieser Schritt ist optional 
        # und dient der Klarheit, dass das Image bereitsteht.
        run: docker pull pspdev/pspdev:latest

      # Step 3: PSPDEV Umgebung initialisieren und Build ausführen
      - name: Configure and Build PSP Project
        # Wir verwenden docker run, um in das Container-Verzeichnis zu springen
        # und dort alle Kompilierungsschritte auszuführen.
        run: |
          # Führe den Container aus:
          # -ti: Interaktiver Pseudo-TTY (gut für die Shell-Umgebung)
          # -v $PWD:/source: Bindet das lokale Repository ($PWD) an das Verzeichnis /source im Container
          # pspdev/pspdev:latest: Das zu verwendende Image
          # /bin/bash -c "..." : Startet Bash im Container und führt die folgenden Befehle aus
          docker run -ti -v $PWD:/source pspdev/pspdev:latest /bin/bash -c "
            # In das Quellverzeichnis wechseln
            cd /source

            # Umgebungsvariable PSPDEV setzen (wird oft im Container benötigt)
            export PSPDEV=/usr/local/pspdev

            # --- Projekt spezifische Build-Schritte hier einfügen ---
            # Beispiel für ein cmake-basiertes Projekt:

            # 1. Build-Verzeichnis erstellen und wechseln
            mkdir build
            cd build

            # 2. CMake ausführen (generiert Makefiles)
            # Fügen Sie hier Ihre spezifischen Build-Optionen hinzu, z.B. -DBUILD_PRX=1
            psp-cmake ..

            # 3. Kompilieren (nutzt alle verfügbaren Kerne)
            make -j$(nproc)
            
            # 4. (Optional) Dateien zurückkopieren/speichern
            # Wenn Sie die kompilierten Dateien (z.B. EBOOT.PBP) außerhalb des 'build'-Ordners benötigen
            # cp <Pfad zur EBOOT.PBP> /source/
          "

      # Step 4: (Optional) Hochladen des Build-Artefakts
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: psp-build-output
          # Passen Sie den Pfad an, wo Ihre EBOOT.PBP/PRX liegt
          path: build/EBOOT.PBP
          # oder
          # path: /source/*.prx
